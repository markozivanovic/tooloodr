/**
 *  TooLooDR v1.0.2
 *  Copyright (C) 2021 Marko Zivanovic <https://markozivanovic.com>
 *
 *  This program is free software: you can redistribute it and/or modify
 *  it under the terms of the GNU General Public License as published by
 *  the Free Software Foundation, either version 3 of the License, or
 *  (at your option) any later version.
 *
 *  This program is distributed in the hope that it will be useful,
 *  but WITHOUT ANY WARRANTY; without even the implied warranty of
 *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 *  GNU General Public License for more details.
 *
 *  You should have received a copy of the GNU General Public License
 *  along with this program.  If not, see <https://www.gnu.org/licenses/>.
 */
class TooLooDR{constructor(a,b){"undefined"==typeof b&&(b={}),this.contentElement=a,this.options=this.recursiveAssign({defaultTooLooLevel:2,textHighlighting:!0,buttonLabels:{show:!0,tooLoo1:"tldr1",tooLoo2:"tldr2",tooLoo3:"tldr3"},buttonColors:{tooLoo1Text:"#000",tooLoo2Text:"#000",tooLoo3Text:"#000",tooLoo1Background:"#ffaaa7",tooLoo2Background:"#ffd3b4",tooLoo3Background:"#d5ecc2",activeBorderColor:"#f00"},readingTime:{show:!0,wordsPerMin:200,labelSeparator:"\u2022",showPercentage:!0,percentageSeparator:"\u2022"},levelColors:{tooLoo1Text:"#000",tooLoo2Text:"#000",tooLoo3Text:"#000",tooLoo1Background:"#ffaaa7",tooLoo2Background:"#ffd3b4",tooLoo3Background:"#d5ecc2"}},b),this.addTooLoo(this.contentElement,this.options),this.initiateDefaultLevel(this.options,this.contentElement)}addTooLoo(a,b){let c=document.querySelector(a).innerHTML,d=c;for(let d,e=1;3>=e;e++)d="<span class=\"tldr"+e+"\">",b.textHighlighting&&(d="<span class=\"tldr"+e+"\" ",1===e?(d+="style=\"color:"+b.levelColors.tooLoo1Text+";",d+="background-color:"+b.levelColors.tooLoo1Background+";\">"):2===e?(d+="style=\"color:"+b.levelColors.tooLoo2Text+";",d+="background-color:"+b.levelColors.tooLoo2Background+";\">"):3===e?(d+="style=\"color:"+b.levelColors.tooLoo3Text+";",d+="background-color:"+b.levelColors.tooLoo3Background+";\">"):void 0),c=c.replace(new RegExp("\\[tl"+e+"]","g"),d),c=c.replace(new RegExp("\\[\\/tl"+e+"]","g"),"</span>");let e={};b.readingTime.show&&(e=this.getReadingTimes(d,b.readingTime)),document.querySelector(a).innerHTML="",document.querySelector(a).innerHTML=c,this.loadButtons(a,b,e)}getReadingTimes(a,b){a=a.replace(/<(.|\n)*?>/g,""),a=a.replace(/(^\s*)|(\s*$)/gi,""),a=a.replace(/\s\s+/g," "),a=a.replace(/\r?\n|\r/gi," ");let c=[];for(let d,e=1;3>=e;e++)d=new RegExp("\\[tl"+e+"]([\\s\\S]*?)\\[\\/tl"+e+"]","g"),c.push(a.match(d));let d=[];c.forEach(function(a,b){d[b]=0,null!==a&&a.forEach(function(a){1==b&&(a=a.replace(/\[tl3]([\s\S]*?)\[\/tl3]/g,"")),a=a.replace(/\[tl(.)\]/g,""),a=a.replace(/\[\/tl(.)\]/g,""),a=a.replace(/(^\s*)|(\s*$)/gi,""),a=a.replace(/\s\s+/g," "),d[b]+=a.split(" ").length})});let e=d[2],f=d[1],g=d[0]-d[1]-d[2],h=g+f+e,i=this.getReadingTimeString(g,b,h),j=this.getReadingTimeString(g+f,b,h),k=this.getReadingTimeString(g+f+e,b,h);return{tooLoo1:i,tooLoo2:j,tooLoo3:k}}getReadingTimeString(a,b,c){let d=Math.trunc(a/b.wordsPerMin),e=Math.ceil(60*(a/b.wordsPerMin%1)),f="";return f=0<d?d+" min "+(e+" sec"):e+" sec",b.showPercentage&&(f+=" "+b.percentageSeparator+" "+(Math.trunc(100*(a/c))+"%")),f}loadButtons(a,b,c){let d=this.getButtonHtml("tldr1",b.buttonColors.tooLoo1Text,b.buttonColors.tooLoo1Background,b.buttonLabels.tooLoo1,c.tooLoo1,b,"disabled"),e=this.getButtonHtml("tldr2",b.buttonColors.tooLoo2Text,b.buttonColors.tooLoo2Background,b.buttonLabels.tooLoo2,c.tooLoo2,b),f=this.getButtonHtml("tldr3",b.buttonColors.tooLoo3Text,b.buttonColors.tooLoo3Background,b.buttonLabels.tooLoo3,c.tooLoo3,b),g=document.createRange().createContextualFragment("<p class=\"tooloodr-buttons\">"+d+e+f+"</p>");document.querySelector(a).prepend(g)}getButtonHtml(a,b,c,d,e,f,g=""){let h="<button "+g;return h+=" style=\"margin: 0 5px 10px 0;color:"+b+";background-color:"+c+";border:2px solid "+f.buttonColors.activeBorderColor+"\"",h+=" data-tldr-class=\""+a+"\" class=\"active btn btn-"+a+"\">",h+=f.buttonLabels.show?d:"",f.readingTime.show&&(f.buttonLabels.show&&(h+=" "+f.readingTime.labelSeparator+" "),h+=e),h+="</button>",h}initiateDefaultLevel(a,b){console.log(b);let c=[],d=null;switch(a.defaultTooLooLevel){case 1:c.push("tldr2","tldr3"),document.querySelector(b+" > p > .btn-tldr2").classList.remove("active"),document.querySelector(b+" > p > .btn-tldr2").style.border="1px solid transparent",document.querySelector(b+" > p > .btn-tldr3").classList.remove("active"),document.querySelector(b+" > p > .btn-tldr3").style.border="1px solid transparent",d=document.querySelectorAll(b+" .tldr2");for(var e=0;e<d.length;e++)d[e].style.display="none";d=document.querySelectorAll(b+" .tldr3");for(var e=0;e<d.length;e++)d[e].style.display="none";let f=document.querySelector(b+" > p > .btn-tldr3");f.disabled=!0,f.classList.remove("active");break;case 2:c.push("tldr3"),document.querySelector(b+" > p > .btn-tldr3").classList.remove("active"),document.querySelector(b+" > p > .btn-tldr3").style.border="1px solid transparent",d=document.querySelectorAll(b+" .tldr3");for(var e=0;e<d.length;e++)d[e].style.display="none";case 3:default:}this.addButtonClickListeners(c,a,b)}addButtonClickListeners(a,b,c){document.querySelectorAll(c+" [class*=\" btn-tldr\"]").forEach(function(d){d.addEventListener("click",function(){let d=this.dataset.tldrClass;if(!a.includes(d)){a.push(d),document.querySelector(c+" > p > .btn-"+d).classList.remove("active"),document.querySelector(c+" > p > .btn-"+d).style.border="1px solid transparent";let b=document.querySelectorAll(c+" ."+d);for(var e=0;e<b.length;e++)b[e].style.display="none";if("tldr2"===d){let a=document.querySelector(c+" > p > .btn-tldr3");a.disabled=!0,a.classList.remove("active"),a.style.border="1px solid transparent";let b=document.querySelectorAll(c+" .tldr3");for(var e=0;e<b.length;e++)b[e].style.display="none"}}else{var f=a.indexOf(d);-1<f&&a.splice(f,1);let g=document.querySelectorAll(c+" ."+d);for(var e=0;e<g.length;e++)g[e].style.display="inline";if(document.querySelector(c+" > p > .btn-"+d).classList.add("active"),document.querySelector(c+" > p > .btn-"+d).style.border="2px solid "+b.buttonColors.activeBorderColor,"tldr2"===d){let d=document.querySelector(c+" > p > .btn-tldr3");if(d.disabled=!1,!a.includes("tldr3")){d.classList.add("active"),d.style.border="2px solid "+b.buttonColors.activeBorderColor;let a=document.querySelectorAll(c+" .tldr3");for(var e=0;e<a.length;e++)a[e].style.display="inline"}}}})})}recursiveAssign(c,d){if(Object(d)!==d)return d;for(let a in Object(c)!==c&&(c={}),d)c[a]=this.recursiveAssign(c[a],d[a]);return c}}